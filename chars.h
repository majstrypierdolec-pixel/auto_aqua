#ifndef CUSTOM_CHARS_H
#define CUSTOM_CHARS_H

#include "display.h"

#pragma once
#include <Arduino.h>
#include <avr/pgmspace.h>
#include <stdint.h>

#define LCD_AVAILABLE_CHAR_SLOTS 8

struct LanguageGlyphSet {
  const uint8_t (*glyphs)[8];
  uint8_t glyphCount;
};

const uint8_t dropChars[4][8] PROGMEM = {
    {4, 4, 14, 14, 14, 31, 31, 31},
    {1, 2, 2, 2, 2, 3, 1, 0},
    {31, 31, 31, 31, 31, 15, 3, 31},
    {16, 24, 24, 24, 24, 24, 16, 0},
};

const uint8_t glyphs_polish[][8] PROGMEM = {
    {0x00, 0x00, 0x0e, 0x11, 0x1f, 0x10, 0x0e, 0x01},
    {0x00, 0x04, 0x04, 0x06, 0x0C, 0x04, 0x04, 0x06},
    {0x02, 0x04, 0x00, 0x0E, 0x11, 0x11, 0x11, 0x0E}};

const uint8_t glyphs_russian[][8] PROGMEM = {
    {0x00, 0x00, 0x00, 0x11, 0x13, 0x15, 0x19, 0x11},
    {0x00, 0x0A, 0x04, 0x11, 0x13, 0x15, 0x19, 0x11},
    {0x1F, 0x11, 0x11, 0x0F, 0x03, 0x05, 0x09, 0x11},
    {0x00, 0x00, 0x00, 0x1E, 0x01, 0x0E, 0x01, 0x1E},
    {0x00, 0x00, 0x00, 0x11, 0x11, 0x1D, 0x13, 0x1D},
    {0x00, 0x00, 0x00, 0x18, 0x08, 0x0E, 0x09, 0x0E},
    {0x00, 0x00, 0x00, 0x07, 0x09, 0x09, 0x1F, 0x11},
    {0x11, 0x11, 0x11, 0x11, 0x1F, 0x00, 0x00, 0x00}};

const uint8_t glyphs_francais[][8] PROGMEM = {
    {0x00, 0x00, 0x00, 0x0E, 0x10, 0x10, 0x0E, 0x04},
    {0x02, 0x04, 0x00, 0x0E, 0x11, 0x1E, 0x10, 0x0E},
    {0x02, 0x04, 0x1F, 0x10, 0x1F, 0x10, 0x10, 0x1F},
    {0x04, 0x0A, 0x00, 0x0E, 0x01, 0x1F, 0x11, 0x0E},
    {0x00, 0x14, 0x0A, 0x00, 0x1E, 0x11, 0x11, 0x11}};

const uint8_t glyphs_espanol[][8] PROGMEM = {
    {0x00, 0x14, 0x0A, 0x00, 0x1E, 0x11, 0x11, 0x11}};

const uint8_t glyphs_portugues[][8] PROGMEM = {
    {0x04, 0x0A, 0x00, 0x0E, 0x11, 0x1E, 0x10, 0x0E},
    {0x14, 0x0A, 0x00, 0x0E, 0x01, 0x1F, 0x11, 0x0E},
    {0x00, 0x00, 0x0E, 0x11, 0x1F, 0x10, 0x0E, 0x00},
    {0x00, 0x00, 0x0E, 0x11, 0x1F, 0x10, 0x0E, 0x00},
    {0x00, 0x00, 0x0E, 0x11, 0x1F, 0x10, 0x0E, 0x00},
    {0x00, 0x00, 0x0E, 0x11, 0x1F, 0x10, 0x0E, 0x00},
    {0x00, 0x00, 0x0E, 0x11, 0x1F, 0x10, 0x0E, 0x00}};

static const LanguageGlyphSet GLYPH_SETS[10] PROGMEM = {
    {glyphs_polish, 3}, {nullptr, 0},          {glyphs_russian, 8},
    {nullptr, 0},       {glyphs_francais, 5},  {glyphs_espanol, 1},
    {nullptr, 0},       {glyphs_portugues, 7}, {nullptr, 0},
    {nullptr, 0}};

uint8_t scratch[8];

void makeRevealFrame(uint8_t charIndex, uint8_t revealRows,
                     uint8_t scratchBuf[]) {
  for (uint8_t row = 0; row < 8; row++) {
    uint8_t pix = pgm_read_byte(&dropChars[charIndex][row]);
    if (row < 8 - revealRows)
      pix = 0;
    scratchBuf[row] = pix;
  }
}

void animateIcon(uint8_t slots[4], uint8_t revealRows, uint8_t scratchBuf[]) {
  for (uint8_t i = 0; i < 4; i++) {
    makeRevealFrame(i, revealRows, scratchBuf);
    lcd.createChar(slots[i], scratchBuf);
  }
}

void loadCharSet(const uint8_t (*charset)[8], uint8_t count,
                 uint8_t startSlot = 0) {
  uint8_t buf[8];
  for (uint8_t i = 0; i < count; i++) {
    for (uint8_t b = 0; b < 8; b++) {
      buf[b] = pgm_read_byte(&charset[i][b]);
    }
    lcd.createChar(startSlot + i, buf);
  }
}

void loadGlyphSet(uint8_t langIndex) {
  LanguageGlyphSet set;
  memcpy_P(&set, &GLYPH_SETS[langIndex], sizeof(LanguageGlyphSet));
  if (!set.glyphs || set.glyphCount == 0)
    return;
  if (langIndex == 2) {
    Serial.print("DO NOT USE loadGlyphSet for Russian\nSince Russian has too "
                 "many letters, CGRAM is insufficient.");
    Serial.print("Ignoring. Continuing...");
  };
  loadCharSet(set.glyphs, set.glyphCount, 0);
}

#endif
